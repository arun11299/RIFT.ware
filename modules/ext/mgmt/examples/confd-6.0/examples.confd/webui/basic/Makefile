#####################################################################
# WebUI Intro example
# (C) 2012 Tail-f Systems
######################################################################

usage:
	@echo "See README file for more instructions"
	@echo "make all     Build autogenerated Web UI"
	@echo "make clean   Remove all built and intermediary files"
	@echo "make start   Start ConfD daemon "
	@echo "make stop    Stop any ConfD daemon"
	@echo "make query   Run query against ConfD"
	@echo "make cli     Start the ConfD Command Line Interface"
	@echo "make http    Browse to http://127.0.0.1:8008"

######################################################################
# Where is ConfD installed? Make sure CONFD_DIR points it out
CONFD_DIR ?= ../../..

# Include standard ConfD build definitions and rules
include $(CONFD_DIR)/src/confd/build/include.mk

# In case CONFD_DIR is not set (correctly), this rule will trigger
$(CONFD_DIR)/src/confd/build/include.mk:
	@echo 'Where is ConfD installed? Set $$CONFD_DIR to point it out!'
	@echo ''
	@exit 1

CONFD_HOST  ?= 127.0.0.1
CONFD_FLAGS ?= --addloadpath $(CONFD_DIR)/etc/confd
EXTRA_LINK_FLAGS ?= --use-description -f $(CONFD_DIR)/src/confd/yang

YANG_FXS_FILES = $(CONFD_DIR)/etc/confd/ietf-inet-types.fxs $(CONFD_DIR)/etc/confd/ietf-yang-types.fxs

all: config.fxs types.fxs oper_data cdb_oper_data confd_cli ssh-keydir

######################################################################
# Build daemons

oper_data: config.h oper_data.o
	$(CC) -o $@ oper_data.o $(LIBS)

cdb_oper_data: config.h cdb_oper_data.o
	$(CC) -o $@ cdb_oper_data.o $(LIBS)

confd_cli:
	ln -s $(CONFD_DIR)/bin/confd_cli .

######################################################################
clean:
	-rm -rf confd_cli oper_data cdb_oper_data ssh-keydir *.log *.o *.fxs *.xso *.cs *.access *.dat *.1 *.siz *.idx *.db confd-cdb/*.cdb confd-cdb/rollback* global.data *.h 2> /dev/null || true

######################################################################
start:  stop
	echo "Please wait..."; $(CONFD) -c confd.conf $(CONFD_FLAGS)
	./oper_data &
	./cdb_oper_data &

lstart:  stop
	$(CONFD) -i -c confd.conf $(CONFD_FLAGS)

######################################################################
stop:
	$(CONFD) --stop || true
	$(KILLALL) oper_data cdb_oper_data || true

######################################################################
cli:
	$(CONFD_DIR)/bin/confd_cli --user=admin --groups=admin --interactive --host $(CONFD_HOST) || echo Exit

######################################################################
query:
	$(CONFD_DIR)/bin/netconf-console-tcp --host $(CONFD_HOST) cmd-get-config.xml

######################################################################
http:
	firefox http://$(CONFD_HOST):8008&
